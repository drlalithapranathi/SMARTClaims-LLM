<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epic Patient Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üè• Epic Patient Viewer</h1>
                <div id="user-info"></div>
            </div>
            <div class="epic-badge">Connected to Epic</div>
        </header>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading patient data from Epic...</p>
            </div>
        </div>
    </div>

    <script>
        let client = null;
        FHIR.oauth2.ready()
            .then(function(smartClient) {
                client = smartClient;
                displayUserInfo();
                return loadPatientData();
            })
            .catch(function(error) {
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <div class="error">
                            <strong>‚ùå Connection Failed</strong>
                            <p>${error.message || 'Failed to connect to Epic'}</p>
                            <p style="font-size: 12px;">Make sure you launched from Epic's LaunchPad at 
                               <a href="https://open.epic.com/Launchpad/OAuth2Sso">open.epic.com/Launchpad</a></p>
                        </div>
                    </div>
                `;
            });

        // Display logged-in user information
        function displayUserInfo() {
            const userInfo = document.getElementById('user-info');
            
            // Get user from token response
            if (client.user && client.user.fhirUser) {
                client.request(client.user.fhirUser)
                    .then(function(user) {
                        const name = user.name ? 
                            (user.name[0].given?.join(' ') + ' ' + user.name[0].family) : 
                            'Unknown User';
                        userInfo.textContent = `Logged in as: ${name}`;
                    })
                    .catch(function() {
                        userInfo.textContent = 'User: ' + (client.user.fhirUser || 'Unknown');
                    });
            }
        }

        // Load all patient data
        async function loadPatientData() {
            try {
                const patient = await client.patient.read();
                let html = buildPatientCard(patient);
                html += buildTabsUI();

                document.getElementById('content').innerHTML = html;

                setupTabs();

                loadConditions();
                loadMedications();
                loadAllergies();
                loadObservations();
                
            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div class="card">
                        <div class="error">
                            <strong>‚ùå Error Loading Patient</strong>
                            <p>${error.message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Build patient information card
        function buildPatientCard(patient) {
            const name = patient.name?.[0];
            const fullName = name ? 
                `${name.given?.join(' ') || ''} ${name.family || ''}`.trim() : 
                'Unknown';
            const initials = fullName.split(' ').map(n => n[0]).join('').substring(0, 2);
            
            const birthDate = patient.birthDate || 'Unknown';
            const gender = patient.gender ? 
                patient.gender.charAt(0).toUpperCase() + patient.gender.slice(1) : 
                'Unknown';
            
            // Calculate age
            let age = 'Unknown';
            if (patient.birthDate) {
                const birth = new Date(patient.birthDate);
                const today = new Date();
                age = Math.floor((today - birth) / (365.25 * 24 * 60 * 60 * 1000));
            }
            
            // Get MRN from identifiers
            let mrn = 'N/A';
            if (patient.identifier) {
                const mrnId = patient.identifier.find(id => 
                    id.type?.text === 'MRN' || 
                    id.type?.coding?.some(c => c.code === 'MR')
                );
                if (mrnId) mrn = mrnId.value;
            }
            
            // Get address
            let address = 'Not available';
            if (patient.address?.[0]) {
                const addr = patient.address[0];
                address = [
                    addr.line?.join(', '),
                    addr.city,
                    addr.state,
                    addr.postalCode
                ].filter(Boolean).join(', ');
            }
            
            // Get phone
            let phone = 'Not available';
            if (patient.telecom) {
                const phoneContact = patient.telecom.find(t => t.system === 'phone');
                if (phoneContact) phone = phoneContact.value;
            }

            return `
                <div class="card">
                    <div class="patient-header">
                        <div class="patient-avatar">${initials}</div>
                        <div class="patient-info">
                            <h3>${fullName}</h3>
                            <p>MRN: ${mrn} | FHIR ID: ${patient.id}</p>
                        </div>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <label>Date of Birth</label>
                            <span>${birthDate}</span>
                        </div>
                        <div class="info-item">
                            <label>Age</label>
                            <span>${age} years</span>
                        </div>
                        <div class="info-item">
                            <label>Gender</label>
                            <span>${gender}</span>
                        </div>
                        <div class="info-item">
                            <label>Phone</label>
                            <span>${phone}</span>
                        </div>
                        <div class="info-item" style="grid-column: span 2;">
                            <label>Address</label>
                            <span>${address}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Build tabs UI
        function buildTabsUI() {
            return `
                <div class="tabs">
                    <button class="tab active" data-tab="conditions">Conditions</button>
                    <button class="tab" data-tab="medications">Medications</button>
                    <button class="tab" data-tab="allergies">Allergies</button>
                    <button class="tab" data-tab="vitals">Vitals</button>
                </div>
                
                <div id="conditions" class="tab-content active">
                    <div class="card">
                        <h2>ü©∫ Active Conditions</h2>
                        <div id="conditions-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading conditions...</p>
                        </div>
                    </div>
                </div>
                
                <div id="medications" class="tab-content">
                    <div class="card">
                        <h2>üíä Current Medications</h2>
                        <div id="medications-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading medications...</p>
                        </div>
                    </div>
                </div>
                
                <div id="allergies" class="tab-content">
                    <div class="card">
                        <h2>‚ö†Ô∏è Allergies</h2>
                        <div id="allergies-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading allergies...</p>
                        </div>
                    </div>
                </div>
                
                <div id="vitals" class="tab-content">
                    <div class="card">
                        <h2>üìä Recent Vitals</h2>
                        <div id="vitals-list" class="loading">
                            <div class="spinner"></div>
                            <p>Loading vitals...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Set up tab switching
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });
        }

        // Load conditions
        async function loadConditions() {
            const container = document.getElementById('conditions-list');
            const patientId = client.patient.id;
            
            try {
                // Try without clinical-status filter first (Epic may not support it for all patients)
                let bundle;
                try {
                    bundle = await client.request(`Condition?patient=${patientId}`);
                } catch (e) {
                    // If that fails, show specific error
                    throw e;
                }
                
                const conditions = bundle.entry?.map(e => e.resource) || [];
                
                if (conditions.length === 0) {
                    container.innerHTML = '<div class="empty">No conditions found for this patient</div>';
                    return;
                }
                
                container.innerHTML = conditions.map(condition => {
                    const name = condition.code?.text || 
                                condition.code?.coding?.[0]?.display || 
                                'Unknown Condition';
                    const date = condition.recordedDate ? 
                        new Date(condition.recordedDate).toLocaleDateString() : 
                        'Date unknown';
                    const severity = condition.severity?.text || '';
                    const status = condition.clinicalStatus?.coding?.[0]?.code || '';
                    
                    return `
                        <div class="list-item">
                            <strong>${name}</strong>
                            <small>Recorded: ${date} ${status ? '| Status: ' + status : ''} ${severity ? '| Severity: ' + severity : ''}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                const errorMsg = error.message || 'Unknown error';
                const statusCode = error.status || error.statusCode || '';
                
                // Check if it's a scope/permission issue
                let helpText = '';
                if (statusCode === 403 || errorMsg.includes('403')) {
                    helpText = '<br><small>This may be due to: (1) The test patient has no conditions, (2) Your app needs Condition.Read API enabled, or (3) Scope mismatch between requested and granted scopes.</small>';
                }
                
                container.innerHTML = 
                    `<div class="error">Error loading conditions: ${statusCode} ${errorMsg}${helpText}</div>`;
            }
        }

        // Load medications
        async function loadMedications() {
            try {
                const bundle = await client.request(
                    `MedicationRequest?patient=${client.patient.id}&status=active`
                );
                
                const medications = bundle.entry?.map(e => e.resource) || [];
                const container = document.getElementById('medications-list');
                
                if (medications.length === 0) {
                    container.innerHTML = '<div class="empty">No active medications found</div>';
                    return;
                }
                
                container.innerHTML = medications.map(med => {
                    let name = 'Unknown Medication';
                    if (med.medicationCodeableConcept) {
                        name = med.medicationCodeableConcept.text || 
                               med.medicationCodeableConcept.coding?.[0]?.display || name;
                    } else if (med.medicationReference?.display) {
                        name = med.medicationReference.display;
                    }
                    
                    const dosage = med.dosageInstruction?.[0]?.text || 
                                  med.dosageInstruction?.[0]?.patientInstruction || 
                                  'No dosage information';
                    const date = med.authoredOn ? 
                        new Date(med.authoredOn).toLocaleDateString() : '';
                    
                    return `
                        <div class="list-item">
                            <strong>${name}</strong>
                            <small>${dosage} ${date ? '| Prescribed: ' + date : ''}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('medications-list').innerHTML = 
                    `<div class="error">Error loading medications: ${error.message}</div>`;
            }
        }

        // Load allergies
        async function loadAllergies() {
            try {
                const bundle = await client.request(
                    `AllergyIntolerance?patient=${client.patient.id}`
                );
                
                const allergies = bundle.entry?.map(e => e.resource) || [];
                const container = document.getElementById('allergies-list');
                
                if (allergies.length === 0) {
                    container.innerHTML = '<div class="empty">No allergies recorded</div>';
                    return;
                }
                
                container.innerHTML = allergies.map(allergy => {
                    const name = allergy.code?.text || 
                                allergy.code?.coding?.[0]?.display || 
                                'Unknown Allergen';
                    const criticality = allergy.criticality || 'Unknown';
                    const reactions = allergy.reaction?.map(r => 
                        r.manifestation?.map(m => m.text || m.coding?.[0]?.display).join(', ')
                    ).join('; ') || 'Not specified';
                    
                    const cssClass = criticality === 'high' ? 'danger' : 
                                    criticality === 'low' ? '' : 'warning';
                    
                    return `
                        <div class="list-item ${cssClass}">
                            <strong>${name}</strong>
                            <small>Criticality: ${criticality} | Reactions: ${reactions}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('allergies-list').innerHTML = 
                    `<div class="error">Error loading allergies: ${error.message}</div>`;
            }
        }

        // Load vital signs
        async function loadObservations() {
            const container = document.getElementById('vitals-list');
            const patientId = client.patient.id;
            
            try {
                // Try vital-signs category first, fall back to general observations
                let bundle;
                try {
                    bundle = await client.request(
                        `Observation?patient=${patientId}&category=vital-signs&_count=20`
                    );
                } catch (e) {
                    bundle = await client.request(
                        `Observation?patient=${patientId}&_count=20`
                    );
                }
                
                const observations = bundle.entry?.map(e => e.resource) || [];
                
                if (observations.length === 0) {
                    container.innerHTML = '<div class="empty">No observations found for this patient</div>';
                    return;
                }
                
                container.innerHTML = observations.map(obs => {
                    const name = obs.code?.text || 
                                obs.code?.coding?.[0]?.display || 
                                'Unknown Observation';
                    
                    let value = 'No value';
                    if (obs.valueQuantity) {
                        value = `${obs.valueQuantity.value} ${obs.valueQuantity.unit || ''}`;
                    } else if (obs.valueCodeableConcept) {
                        value = obs.valueCodeableConcept.text || 
                               obs.valueCodeableConcept.coding?.[0]?.display;
                    } else if (obs.component) {
                        // Handle blood pressure style observations
                        value = obs.component.map(c => {
                            const compName = c.code?.coding?.[0]?.display || c.code?.text || '';
                            const compValue = c.valueQuantity ? 
                                `${c.valueQuantity.value}${c.valueQuantity.unit || ''}` : '';
                            return `${compName}: ${compValue}`;
                        }).join(' / ');
                    }
                    
                    const date = obs.effectiveDateTime ? 
                        new Date(obs.effectiveDateTime).toLocaleString() : 
                        'Date unknown';
                    
                    return `
                        <div class="list-item">
                            <strong>${name}: ${value}</strong>
                            <small>${date}</small>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                const statusCode = error.status || error.statusCode || '';
                container.innerHTML = 
                    `<div class="error">Error loading vitals: ${statusCode} ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
