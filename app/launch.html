<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartClaims - Launching...</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .loading {
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner"></div>
        <h2>Connecting to EHR...</h2>
        <p>Please wait while we establish a secure connection.</p>
    </div>
    <script src="js/app-config.js"></script>
    <script>
        /**
         * SmartClaims - EHR Launch Handler
         *
         * This page is called by an EHR (Epic, Cerner, OpenEMR) with two query parameters:
         * - iss: The FHIR server base URL
         * - launch: A one-time use token for this launch session
         *
         * The fhirclient library handles the OAuth2 flow automatically.
         * This handler auto-detects which EHR is launching based on the iss parameter.
         */

        // Get launch parameters from URL
        const urlParams = new URLSearchParams(window.location.search);
        const iss = urlParams.get('iss');
        const launch = urlParams.get('launch');

        if (!iss || !launch) {
            document.body.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h2>⚠️ Invalid Launch</h2>
                    <p>This app must be launched from within an EHR system.</p>
                    <p>Missing parameters: ${!iss ? 'iss ' : ''}${!launch ? 'launch' : ''}</p>
                    <hr style="margin: 20px 0; border-color: rgba(255,255,255,0.3);">
                    <p><strong>For standalone launch:</strong></p>
                    <p><a href="standalone.html" style="color: white;">Click here to select your EHR</a></p>
                    <hr style="margin: 20px 0; border-color: rgba(255,255,255,0.3);">
                    <p><strong>For Epic testing:</strong></p>
                    <p>Use Epic's Launch Pad at <a href="https://fhir.epic.com/Documentation?docId=launching" style="color: white;" target="_blank">fhir.epic.com</a></p>
                </div>
            `;
        } else {
            // Detect which EHR based on the iss parameter
            const ehrKey = detectEHR(iss);
            const config = getEHRConfig(ehrKey);

            console.log("=== EHR Launch Detected ===");
            console.log("  EHR System:", config.name);
            console.log("  FHIR Server (iss):", iss);
            console.log("  Launch Token:", launch);
            console.log("  Client ID:", config.clientId);
            console.log("  Scopes:", config.scope);
            console.log("========================");

            // Check if client ID is configured
            if (!config.clientId) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h2>⚠️ Configuration Missing</h2>
                        <p>${config.name} client ID is not configured.</p>
                        <p>Please register your app with ${config.name} and update app-config.js</p>
                        <p style="font-size: 12px; margin-top: 20px;">Detected FHIR Server: ${iss}</p>
                    </div>
                `;
            } else {
                // Build SMART authorization config
                const smartConfig = {
                    clientId: config.clientId,
                    scope: config.scope,
                    redirectUri: config.redirectUri
                };

                // Initiate the SMART authorization flow
                FHIR.oauth2.authorize(smartConfig)
                    .catch(function(error) {
                        console.error("Authorization error:", error);
                        document.body.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <h2>❌ Authorization Failed</h2>
                                <p><strong>EHR:</strong> ${config.name}</p>
                                <p><strong>Error:</strong> ${error.message || 'Unknown error occurred'}</p>
                                <p style="font-size: 12px; opacity: 0.8; margin-top: 20px;">Check browser console for details</p>
                            </div>
                        `;
                    });
            }
        }
    </script>
</body>
</html>
